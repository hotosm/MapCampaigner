{% extends 'new_base.html' %}

{% block title %} Create Campaign {% endblock %}

{% block extra_head %}

    <link rel="stylesheet" href="/static/js/leaflet.draw-0.4.9/leaflet.draw.css" type="text/css">

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Campaign Form
                </div>
                <div class="panel-body">
                    <div class="row">
                        <form id="campaign-form" method="POST" action="{{ action }}" role="form">
                        <div class="col-lg-6">
                            {{ form.hidden_tag() }}
                            {% for field in form %}
                                {% if field.name != 'submit' and field.name != 'csrf_token' %}
                                    <div class="form-group">
                                        {% if field.name !='geometry' and field.name !='uploader' %}
                                            <label>{{ field.label }}</label>
                                            {% for error in form['errors'][field.name] %}
                                                <div class="error-form">{{ error }}</div>
                                            {% endfor %}
                                            {{ field() }}
                                            <p class="help-block">{{ field.description }}</p>
                                        {% else %}
                                            {{ field() }}
                                        {% endif %}
                                    </div>
                                    <br>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <!-- /.col-lg-6 (nested) -->
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label>Campaign Map</label>
                                <div id="campaign-map"></div>
                            </div>

                            {{ form.submit }}
                        </div>
                        </form>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>

{% endblock %}

{% block after_base_js %}

    <style>

        #map {
            height: 400px;
        }

        .submit-button {
            margin-top: 20px;
        }

    </style>

    <script type="text/javascript" src="/static/js/leaflet.draw-0.4.9/leaflet.draw.js"></script>

    <script type="text/javascript">

        var errors = {{ form['errors'] | safe}};
        if(!isEmpty(errors)) {
            showNotifications('Failed to create a campaign!', 'danger');
        }

        $(function() {
            $('#campaign-form input').addClass('form-control');
            $('#campaign-form textarea').addClass('form-control');
            $('#campaign-form select').addClass('form-control');

            $('.error-form').parent().addClass('has-error');

            $('#submit').removeClass('form-control');
            $('#submit').addClass('btn btn-outline btn-primary submit-button btn-lg btn-block');
        });

        if(!window.isAuthenticated) {
            showNotifications('You need to login first.', 'danger');
            $('#campaign-form').hide();
        } else {
            $('#campaign-form').show();
        }

        function loginSuccess(response) {
            clearNotification();
            $('#campaign-form').show();
        }

        function logoutSuccess() {
            window.location.replace("/campaign_manager");
        }

        var drawnItems = new L.FeatureGroup();
        var bounds = [
            [-34.053726, 20.411482],
            [-34.009483, 20.467358]
        ];

        $("#form").submit(function (event) {
            $("#uploader").val($("#profile-name").html());
            if (!auth.authenticated() || !$("#uploader").val()) {
                window.location.replace("/campaign_manager/not-logged-in.html");
            }
        });

        var campaignMap = L.map('campaign-map');
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and ' +
            'contributors, under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 18
        }).addTo(campaignMap);

        $("#submit").click(function () {
            $("#form").submit();
        });
        $("#start_date").attr('data-language', 'en');
        $("#end_date").attr('data-language', 'en');
        $("#start_date").datepicker({
            dateFormat: 'yyyy-mm-dd',
            autoClose: true
        });
        $("#end_date").datepicker({
            dateFormat: 'yyyy-mm-dd',
            autoClose: true
        });

        {# init map #}
        campaignMap.fitBounds(bounds);

        if ($("#geometry").val()) {
            drawnItems = L.geoJSON($.parseJSON($("#geometry").val()));
            campaignMap.fitBounds(drawnItems.getBounds());
        }
        campaignMap.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                polyline: false,
                marker: false,
                circle: false
            },
            edit: {
                featureGroup: drawnItems
            },
            remove: {
                featureGroup: drawnItems
            }
        }, this);

        campaignMap.addControl(drawControl);
        campaignMap.on('draw:created', saveLayer);
        campaignMap.on('draw:edited', editLayer);
        campaignMap.on('draw:deleted', deleteLayer);

        function stringfyGeometry() {
            var json = drawnItems.toGeoJSON();
            $("#geometry").val(JSON.stringify(json));
        }

        function saveLayer(e) {
            var layer = e.layer;
            drawnItems.addLayer(layer);
            stringfyGeometry();
        }

        function editLayer(e) {
            var layer = e.layer;
            stringfyGeometry();
        }

        function deleteLayer(e) {
            var layers = e.layers;
            layers.eachLayer(function (feature) {
                drawnItems.removeLayer(feature);
            });
            stringfyGeometry();
        }
    </script>

{% endblock %}
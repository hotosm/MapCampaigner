{% extends 'new_base.html' %}

{% block extra_title %}
    - {{ name }}
{% endblock %}

{% block extra_head %}
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Map Campaigner" />
    <meta property="og:description" content="{{ description }}" />
{% endblock %}

{% block header_content %}

    <script src="http://connect.facebook.net/en_US/all.js" async=""></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Custom CSS -->
    <link href="/static/css/admin-view.css" rel="stylesheet">
    <link href="/static/css/campaign-detail.css" rel="stylesheet">
 
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-7">
            <h3 class="detail-campaign-name">{{ campaign.name }}</h3>
            {% if campaign.featureTypes %}
                {% for feature in campaign.featureTypes %}
                    <label class="detail-tag"> {{ feature.name }} </label>
                {% endfor %}
            {% endif %}
            <p>
                {% if campaign.description %}
                    {{ campaign.description }}
                {% else %}
                    <span class="grey-italic">No description</span>
                {% endif %}
            </p>
        </div>
        <div class="col-lg-5">
            <div class="panel panel-default detail-panel-information">
                <div class="panel-body">
                    <div class="detail-campaign-status {{ current_status }}">
                        <i class="fa fa-circle" aria-hidden="true"></i> <label>{{ current_status }}</label>
                    </div>
                    <div class="detail-campaign-timeline">
                        <span class="pull-left">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Started</span> : {{ start_date }}
                        </span>
                        <span class="pull-right">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Ends</span> : {{ end_date }}
                        </span>
                    </div>
                    <div class="detail-progress">
                        <div class="progress">
                            <div class="progress-bar" id="campaign-progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                    <div class="detail-creator-info">
                        <p>
                            <span class="grey-italic">Campaign Manager : </span>
                            <span class="text-muted">
                                {% if campaign.users %}
                                    {% for manager in campaign.users %}
                                        <a href="https://www.openstreetmap.org/user/{{ manager.osm_user_id }}" target="_blank">{{ manager.osm_user_id }}</a>
                                        {% if manager != campaign.users[-1] %}
                                            ,
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </p>
                        <p>
                            <span class="grey-italic">Creator : </span>
                            <a href="https://www.openstreetmap.org/user/{{ campaign_creator }}" target="_blank">
                            {{ campaign.creator.osm_user_id }}
                            </a>
                        </p>
                        <p>
                            <span class="grey-italic">Map:</span>
                            {% if map_type != '' and map_type != 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' %}
                                <span id="map-default" style="display: none">
                                Default
                                </span>
                                <span id="map-custom">
                                Custom
                                </span>
                            {% else %}
                                <span id="map-default"></span>
                                Default
                            {% endif %}
                        </p>
                    </div>
                    <div class="button-reminder" style="align-self: flex-end;">
                        <button class="btn btn-info button-reminder" style=" background: #FEAD47; border: none;">Set Reminder</button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
    	<div class="col-lg-12 campaign-info">
    		<ul class="nav nav-tabs team-nav">
                {% for team in teams %}
                    <li><a data-toggle="tab" href="{{team.name}}" class="{{ team.name }}" onclick="get_team_chat(this)">{{ team.name }}</a></li>
                {% endfor %}
    		</ul>
    		<div class="tab-content">
                {% for team in teams %}
                    <div class="panel panel-default detail-panel-information">
                        <div class="panel-body summary-stats">
                            <div class="row">
                                <div class="col-lg-4 single-summary-stat">
                                    <div class="summary-stat-title">
                                        Features Collected
                                    </div>
                                    <div class="summary-stat-desc">
                                        <span id="features-collected"><span class="grey-italic">...</span></span>
                                    </div>
                                </div>

                                <div class="col-lg-4 single-summary-stat">
                                    <div class="summary-stat-title">
                                        Users Engaged
                                    </div>
                                    <div class="summary-stat-desc">
                                        <span id="contributors"><span class="grey-italic">...</span></span>
                                    </div>
                                </div>

                                <div class="col-lg-4 single-summary-stat">
                                    <div class="summary-stat-title">
                                        Areas Covered
                                    </div>
                                    <div class="summary-stat-desc">
                                        <span id="areas-covered"><span class="grey-italic">...</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="home" class="tab-pane fade in active campaign-team-display">
                        <div class="area-stats col-lg-9">
                            <div class="area-info">
                                <div class="completeness"></div>
                                <div class="graph"></div>
                                <div class="feature-collected"></div>   
                            </div>
                            <div class="chat">
                                <div class="panel-body-chat" style="height: 325px;">
                                    <ul class="team-chat chat">
                                    </ul>
                                </div>
                                <div class="panel-footer">
                                    <div class="input-group">
                                        <input id="btn-input" type="text" class="form-control input-sm team-message {{ team.name }}" placeholder="Type your message here..." onclick="set_reciever(this)" />
                                        <span class="input-group-btn">
                                            <button class="btn btn-warning btn-sm" id="btn-chat" onclick="send_team_message()">Send</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="team-stats col-lg-3">
                            <div class="team-members"></div>
                            <div class="team-member-activity"></div>
                            <div class="contribution"></div>
                        </div>
                    </div>
                {% endfor %}

    <div class="row" style="margin-top: 50px;">
        <div class="col-lg-12 team-member-chat">
    	   <div class="team-members-name col-lg-7">
            <h2>Team Name</h2> <!-- from JS based on the above selected team-->
            <h3>Members</h3>
            {% for member in teams[0].users %} <!-- render using JS -->
                <div class="member-name">
                    <div class="member-info">
                        <div class="member-image">
                        </div>
                        <div class="name">{{ member.osm_user_id }}</div>
                    </div>
                    <div class="connect">
                        <button class="btn btn-info {{ member.osm_user_id }}" onclick="get_user_chat(this)"  style="background:#FEAD47; border:none;">Connect</button>
                    </div>
                </div>

            {% endfor %}
            </div> 
            <div class="col-lg-4 member">
                <div class="member-osm-info">
                    <div style="display: flex; justify-content: flex-start; align-items: center; color: white; height: 100%;">
                        <div class="osm-user-image"></div>
                        <div class="osm-id" style="display: flex;flex-direction: column; justify-content: space-around; margin-left: 10px;">
                            <div class="osm-user-name"><h5><b>Surya Saini</b></h5></div>
                            <div class="mapper-since">7-Mar-2017</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body-chat panel-member-chat">
                    <ul class="chat member-chat">
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input id="btn-input" type="text" class="form-control input-sm member-message" id="myMessage" placeholder="Type your message here..."/ onclick="set_reciever(this)">
                        <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" id="btn-chat" class="send-message" onclick="send_message()">Send</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="overlay"></div>
    <div class="row reminder-popup">
        <div role="dialog">
            <div class="modal-dialog">
            <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">+ Add Reminder</h4>
                    </div>
                    <div class="modal-body">
                        <form class="form" action="/add_reminder" method="POST">
                            <div id="modal-form">
                                <label>Reminder</label>
                                <div class="form-group">
                                    <textarea placeholder="add reminder message." type="textarea" value="" class="form-control" name="reminder-message"></textarea>
                                </div>
                                <br>
                                <label>Reminder Date</label>
                                <div class="form-group required-form input-append date form_datetime">
                                    <input size="16" type="text" value="" readonly name="reminder-time">
                                    <span class="add-on"><i id="start-date-icon" class="fa fa-calendar" aria-hidden="true"></i></span>
                                </div>
                                <input type="hidden" name="uuid" value="{{ campaign.uuid }}">
                                <div style="display: flex; justify-content: flex-end;">
                                <button type="submit" class="btn btn-default">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block before_base_js %}
    <script type="text/javascript">

    </script>
{% endblock %}

{% block after_base_js %}
    <script>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                showNotifications('{{ message }}', 'danger');
                {% endfor %}
            {% endif %}
        {% endwith %}

        var socket = io.connect('http://127.0.0.1:5000');
        
        socket.on('message', function(msg){
            var div = '';
            if(msg[0]['type'] == 'member-message'){
                div = '.member-chat';
            }
            else{
                div = '.team-chat';
            }

            $(div).append('<li class="right clearfix">'+'<span class="chat-img pull-right">'+
                '<img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />'+
                '</span>'+'<div class="chat-body clearfix">'+'<div class="header">'+
                '<strong class="primary-font">Member1</strong> <small class="pull-right text-muted">'+
                '<span class="glyphicon glyphicon-time"></span>12 mins ago</small>'+
                '</div>'+'<p>'+msg[0]['message']+'</p>'+'</div>'+'</li>');
            
        });

        var receiver;
        function set_reciever(el){
            receiver = el.className;
            receiver = receiver.replace('form-control input-sm team-message ','');
            receiver = receiver.replace('form-control input-sm member-message ','');
            receiver = receiver.replace('btn btn-info ','');
        }

        function send_message(){            
            // serialize the chat object
            var message = {};
            message['message'] = $('.member-message').val();
            message['sender'] = "{{ admin }}";
            message['receiver'] = receiver;
            message['uuid'] = "{{ campaign.uuid }}";
            message['type'] = "member-message";

            socket.send(message);
            $('.member-message').val('');
        }

        function send_team_message(){            
            // serialize the chat object
            var message = {};
            message['message'] = $('.team-message').val();
            message['sender'] = "{{ admin }}";
            message['receiver'] = receiver;
            message['uuid'] = "{{ campaign.uuid }}";
            message['type'] = "team-message";
            socket.send(message);
            $('.team-message').val('');

        }

        function get_user_chat(el){
            $('.member-message').removeClass(receiver);
            set_reciever(el);
            $('.member-message').addClass(receiver);
            var url = '/get_chat/{{ admin }}/' + receiver;
            $(".member-chat").fadeOut(100);
            setTimeout(
            $.ajax({
                url: url,
                success: function(data){
                    
                    $(".member-chat").html("");
                    Object.keys(data).forEach(function(key){
                        if(data[key]['sender'] == '{{ admin }}'){
                            $(".member-chat").append('<li class="right clearfix">'+'<span class="chat-img pull-right">'+
                                '<img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />'+
                                '</span>'+'<div class="chat-body clearfix">'+'<div class="header">'+
                                '<strong class="primary-font">Member1</strong> <small class="pull-right text-muted">'+
                                '<span class="glyphicon glyphicon-time"></span>12 mins ago</small>'+
                            '</div>'+'<p>'+data[key]['message']+'</p>'+'</div>'+'</li>');
                        }
                        else{
                            $(".member-chat").append('<li class="left clearfix">'+'<span class="chat-img pull-left">'+
                                '<img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" />'+
                                '</span>'+'<div class="chat-body clearfix">'+'<div class="header">'+
                                '<strong class="primary-font">Member1</strong> <small class="pull-left text-muted">'+
                                '<span class="glyphicon glyphicon-time"></span>12 mins ago</small>'+
                            '</div>'+'<p>'+data[key]['message']+'</p>'+'</div>'+'</li>');
                        }
                    });
                    $(".member-chat").fadeIn();
                }
            }),
            100);
        }

        function get_team_chat(el){
            var url = '/get_chat/{{ admin }}/' + el.className;
            $('.team-message').addClass(el.className);
            $.ajax({
                url: url,
                success: function(data){
                    $(".team-chat").html("");
                    Object.keys(data).forEach(function(key){
                        if(data[key]['sender'] == '{{ admin }}'){
                            $(".team-chat").append('<li class="right clearfix">'+'<span class="chat-img pull-right">'+
                                '<img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" />'+
                                '</span>'+'<div class="chat-body clearfix">'+'<div class="header">'+
                                '<strong class="primary-font">Member1</strong> <small class="pull-right text-muted">'+
                                '<span class="glyphicon glyphicon-time"></span>12 mins ago</small>'+
                            '</div>'+'<p>'+data[key]['message']+'</p>'+'</div>'+'</li>');
                        }
                        else{
                            $(".team-chat").append('<li class="left clearfix">'+'<span class="chat-img pull-left">'+
                                '<img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" />'+
                                '</span>'+'<div class="chat-body clearfix">'+'<div class="header">'+
                                '<strong class="primary-font">Member1</strong> <small class="pull-left text-muted">'+
                                '<span class="glyphicon glyphicon-time"></span>12 mins ago</small>'+
                            '</div>'+'<p>'+data[key]['message']+'</p>'+'</div>'+'</li>');
                        }
                    });
                    $(".team-chat").fadeIn();
                }
            });
        }

        function calculateCampaignProgress() {
            var $campaignStatus = $('.detail-campaign-status');
            var $campaignStatusLabel = $('.detail-campaign-status label');
            var start_date =  moment('{{ campaign.start_date }}', 'YYYY-MM-DD', true);
            var end_date = moment('{{ campaign.end_date }}', 'YYYY-MM-DD', true);
            
            if (start_date === 'None' || end_date === 'None') {
                $('.detail-campaign-status label').html('-');
                return;
            }

            var campaign_range = end_date.diff(start_date, 'days') + 1; // Include start

            if (campaign_range < 0) {
                $campaignStatusLabel.html('-');
                return;
            }

            var remaining_days = end_date.diff(moment(), 'days') + 1;

            var progress = 0;
            if (remaining_days <= 0) {
                progress = 100;
                if($campaignStatusLabel.text() == 'Inactive') {
                    $campaignStatus.removeClass('running');
                    $campaignStatus.addClass('finished');
                    $campaignStatusLabel.html('Finished');
                }
            } else {
                progress = 100 - (remaining_days / campaign_range * 100);
                if(progress < 0){
                    progress = 0
                }
            }

            $('#campaign-progress').css({
                'width': progress + '%'
            })
        }

        calculateCampaignProgress();

        /* reminder javascript */
        $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii'});

        $('.close').click(function(){
            hide_popup();
        });

        $('.button-reminder').click(function(){
            $('.reminder-popup').show();
            $('.overlay').show();  
        });

        $('.overlay').click(function(){
            hide_popup();
        });

        function hide_popup(){
            $('.reminder-popup').hide();
            $('.overlay').hide();
        }




    </script>
{% endblock %}

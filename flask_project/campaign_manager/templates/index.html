{% extends 'new_base.html' %}

{% block header_content %}
        <div class="home-header">
            <div class="col-lg-6">
                <div class="row">
                    <div class="col-md-6">
                        <button id="create-campaign" class="btn btn-home btn-lg btn-block">Start a campaign</button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-home btn-lg btn-block" onclick="participate()">Participate</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-1">
                <span class="v-separator"></span>
            </div>
            <div class="col-lg-2 header-info">
                <span class="header-number" id="active-campaign-number">0</span>
                <span class="header-number-text">active campaigns</span>
            </div>

            <div class="col-lg-1">
                <span class="v-separator"></span>
            </div>
            <div class="col-lg-2 header-info crimson">
                <span class="header-number" id="participants-number">0</span> <span class="header-number-text">participants</span>
            </div>

        </div>
{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-custom">
                <div class="panel-heading">
                    <div id="campaign-map"></div>
                </div>
                <div id="panel-campaign">
                    <div class="panel-body">
                    <h4 style="font-weight: bolder; margin-top: -10px;">Active Campaigns</h4>

                    <button id="all-campaigns" type="button" class="btn btn-outline btn-info btn-lg">
                        <i class="fa fa-globe" aria-hidden="true"></i>
                        <span style="margin-left: 5px;">All Campaigns</span>
                    </button>

                    <button id="nearest-campaigns" type="button" class="btn btn-outline btn-info btn-lg">
                        <i class="fa fa-globe" aria-hidden="true"></i>
                        <span style="margin-left: 5px;">Nearest Campaigns</span>
                    </button>


                    <table id="campaign-table">
                        <thead>
                            <tr>
                                <th>
                                    NAME
                                </th>
                                <th>
                                    TYPES
                                </th>
                                <th>
                                    PARTICIPANTS
                                </th>
                                <th>
                                    ACTION
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>


        </div>

    </div>

{% endblock %}

{% block before_base_js %}

    <style type="text/css">

        #campaign-table, #campaign-table_wrapper {
            font-size: 10pt;
        }

        #campaign-table_info {
            font-size: 9pt;
        }

        .paginate_button {
            padding: 0.3em 0.7em !important;
        }

        #campaign-table_wrapper {
            padding-bottom: 20px;
            padding-top: 10px;
        }

        #campaign-table .tag {
            font-size: 9pt;
        }

        #campaign-table_filter input[type=search] {
            border-radius: 4px;
            border: 1px solid #d1d1d1;
        }

        #campaign-table tr.odd {
            background-color: rgba(223, 234, 242, 0.30) !important;
        }


        #campaign-table tr.odd:hover, tr.even:hover {
            background-color: rgba(59, 132, 172, 0.13) !important;
        }

        .label-tag {
            font-size: 12pt;
            position: absolute;
            margin-left: 8px;
            margin-top: 12px;
        }

        .label-tag a {
            color: #bbb;
            cursor: pointer;
            opacity: 0.6;
        }

        .label-tag a:hover {
            opacity: 1.0
        }

        .label-tag .remove-tag {
            vertical-align: bottom;
            top: 0;
        }

        .label-tag a {
            margin: 0 0 0 .3em;
        }

        .label-tag a .glyphicon-white {
            color: #fff;
            margin-bottom: 2px;
        }

        #all-campaigns, #nearest-campaigns {
            display: none;
        }

    </style>

    <script type="text/javascript">

        $(function () {
            var user_location_setting = Cookies.get('user_location_setting');
            var tag = "{{ tag }}";
            if(user_location_setting === 'all') {
                // check current url
                var current_href = window.location.href.split('/');
                if(current_href[current_href.length-1] !== 'all' && !tag) {
                   location.href='/campaign_manager/all';
                }
            }
        });

        var map = L.map('campaign-map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and contributors, ' +
            'under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 15
        }).addTo(map);

        $('#create-campaign').click(function () {
            if (window.isAuthenticated) {
                location.href='/campaign_manager/create';
            } else {
                showNotifications('You need to login first.', 'danger');
            }
        });

    </script>

{% endblock %}

{% block after_base_js %}

    <script type="text/javascript">

        var table = $('#campaign-table').DataTable({
            "lengthChange": false
        });
        $('.dataTables_filter').addClass('pull-left');
        var userCoordinate = '';
        var mapLayers = new L.FeatureGroup();
        var mapMarkers = new L.FeatureGroup();
        var tag = "{{ tag }}";
        map.addLayer(mapMarkers);
        map.addLayer(mapLayers);

        //---------------- EVENT ------------------//
        var homeHeaderTop = $('.home-header').offset().top;

        $(window).scroll(function() {
            var currentScroll = $(window).scrollTop();

            if(currentScroll >= homeHeaderTop) {
                $('.home-header').css({
                    position: 'fixed',
                    top: '0',
                    width: '100%',
                    'z-index': '9999'
                })
                $('#first-row').css({
                    'margin-top':'78px'
                });
            } else {
                $('.home-header').css({
                    position: 'static'
                })
                $('#first-row').css({
                    'margin-top':'0'
                });
            }
        });

        function participate() {
            var participateUrl = "/campaign_manager/participate"
            if(userCoordinate) {
                participateUrl += "?coordinate="+userCoordinate;
            }
            window.location.href = participateUrl;
        }

        function updated(user) {
            clearNotification();
            var currentUser = user.display_name;
            var url = "/campaign_manager/campaigns";
            userCoordinate = user['lat'] + ',' + user['lon'];

            if(user['lon'] && user['lat']) {
                url = "/campaign_manager/nearest_campaigns/" + user['lat'] + ',' + user['lon'];
            }
            clearMap();
            clearTable();
            getCampaigns(url, currentUser);
            getTotalCampaigns();
            {% if not all %}
                $('#all-campaigns').show();
            {% else %}
                $('#nearest-campaigns').show();
            {% endif %}
        }

        $('.remove-tag').click(function () {
            location.href='/campaign_manager'
        })

        $('#all-campaigns').click(function () {
            Cookies.set('user_location_setting', 'all');
            location.href='/campaign_manager/all'
        })

        $('#nearest-campaigns').click(function () {
            Cookies.set('user_location_setting', 'nearest');
            location.href='/campaign_manager'
        })

        function logoutSuccess() {
            clearMap();
            clearTable();
            {% if all %}
                location.href='/campaign_manager'
            {% endif %}
            $('#all-campaigns').hide();
            $('#nearest-campaigns').hide();
        }

        if(!auth.authenticated()) {
            {% if all %}
                location.href='/campaign_manager'
            {% endif %}
            getBrowserLocation();
            getTotalCampaigns();
        }

        function loginError() {
            getBrowserLocation();
        }

        function clearMap() {
            map.removeLayer(mapMarkers);
            map.removeLayer(mapLayers);
            mapLayers = new L.FeatureGroup();
            mapMarkers = new L.FeatureGroup();
            map.addLayer(mapMarkers);
            map.addLayer(mapLayers);
        }

        function clearTable() {
            table.clear().draw('false');
        }

        function getBrowserLocation() {
            // Get user location
            navigator.geolocation.getCurrentPosition(successGetBrowserLocation, errorGetBrowserLocation);

            function successGetBrowserLocation(position) {
                var zoom = 10;
                var userLocation = new L.latLng(position.coords.latitude, position.coords.longitude);
                var url = "/campaign_manager/nearest_campaigns/" + position.coords.latitude + ',' + position.coords.longitude;
                getCampaigns(url);
                userCoordinate = position.coords.latitude + ',' + position.coords.longitude;
                map.setView(userLocation, zoom);
            }

            function errorGetBrowserLocation() {
                console.log('Error get browser location');
                clearMap();
                clearTable();
                getCampaigns();
            }
        }

        function getTotalCampaigns() {
            var url = "/campaign_manager/total_campaigns"
            $.ajax(url, {
                success: function (response) {
                    $('#active-campaign-number').html(response['campaign_total']);
                    $('#participants-number').html(response['participant_total']);
                }
            })
        }

        function getCampaigns(url, user) {

            $('#panel-campaign').LoadingOverlay("show", {image: "/campaign_manager/static/resources/loading-spinner.gif"});

            if(!url) {
                url = "/campaign_manager/campaigns";
            }
            {% if all %}
                url = "/campaign_manager/campaigns";
            {% endif %}

            var campaign_status = '/active';

            url += campaign_status;

            if(tag) {
                url += '/'+tag;
            }

            // Clear campaign list in navbar
            $('.campaign-list-navbar').html('');

            var participants = [];

            $.ajax(url, {
                success: function(campaigns){
                    $.each(campaigns, function (index, campaign) {
                        var types = [];
                        var action_button = '';

                        if(campaign['types']) {
                            $.each(campaign['types'], function (index, type) {
                               types.push(type['type']);
                            });
                            types = types.join()
                        }else{
                            types = '-'
                        }

                        if($.inArray(user, campaign['campaign_managers'])>-1) {
                            action_button = '<button type="button" href="#" class="campaign-list btn"'+
                                                'onclick="location.href=\'/campaign_manager/edit/'+campaign['uuid']+'\'">'+
                                                '<span class="pull-left"><i class="fa fa-cog" aria-hidden="true"></i> Manage</span>'+
                                             '</button>'
                        }

                        $.each(campaign['campaign_managers'], function (index, manager) {
                            if($.inArray(manager, participants)==-1) {
                                participants.push(manager);
                            }
                        })

                        table.row.add([
                            '<span class="campaign-td"><a href="/campaign_manager/campaign/'+campaign['uuid']+'">' + campaign['name'] + '</a></span>',
                            '<span class="tag">'+types+'</span>',
                            '<span class="label label-default label-participants">'+campaign['campaign_managers'].length+'</span>',
                            action_button
                        ]).draw( false );

                        // Add to navigation bar
                        $('.campaign-list-navbar').append('<li>'+
                            '<a href="/campaign_manager/campaign/'+campaign['uuid']+'">'+campaign['name']+'</a>'+
                        '</li>');

                        // Add campaign layer
                        var campaignLayer = L.geoJson(campaign['geometry'], {
                            onEachFeature: function (feature, layer) {
                                // Check if feature is a polygon
                                if (feature.geometry.type === 'Polygon') {
                                    // Don't stroke and do opaque fill
                                    layer.setStyle({
                                        'weight': 0.3,
                                        'fillOpacity': 0.2,
                                        'color': '#FF5722'
                                    });
                                }
                            }
                        }).addTo(mapLayers);

                        var bounds = campaignLayer.getBounds();
                        var center = bounds.getCenter();

                        var marker = L.marker(center, {icon: orangeIcon}).addTo(mapMarkers);
                        marker.bindPopup(
                            '<div class="campaign-marker"><a href="campaign/'+
                                campaign['uuid'] +'"> ' +
                                campaign['name'] +
                            '</a></div>'
                        );
                    });

                    $('#panel-campaign').LoadingOverlay("hide");

                    {% if all %}
                        map.fitBounds(mapLayers.getBounds());
                    {% endif %}
                }
            });
        }

    </script>

{% endblock %}
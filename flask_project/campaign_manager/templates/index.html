{% extends 'new_base.html' %}

{% block header_content %}

    <!-- List Javascript  -->
    <script type="text/javascript" src="/static/libs/list.min.js"></script>
    <script type="text/javascript" src="/static/libs/ellipsis.js"></script>

    <div class="v2-home-header">
        <div class="row">
            <div class="col-lg-6" style="height: 220px">
                <div style="text-align: center; margin-top: 10px">
                    <p><span class="active-campaign-text">Active campaigns:&nbsp;</span>
                        <span class="active-campaign-text-bold" id="active-campaign-number">0</span></p>
                    <p>
                        <a class="underline-text" href="javascript:void(0)" id="display-inactive" style="display: none;">Display inactive campaigns</a>
                        <a class="underline-text" href="javascript:void(0)" id="hide-inactive" style="display: none">Hide inactive campaigns</a>
                    </p>
                </div>
                <div  style="text-align: center; margin-top: 40px; display: flex; justify-content: center;">
                    <table class="home-option">
                        <tr class="home-option">
                            <td id="showing-div" class="home-option">Showing:</td>
                            <td class="home-option">
                                <select class="form-control" id="campaigns-select">
                                    <option value="nearest">nearest</option>
                                    <option value="all">all</option>
                                </select>
                            </td>
                            <td class="home-option nearest-option">
                                <input id="limit-page" name="limit-page" type="text" class="form-control" value="5" style="width: 50px;" onkeypress='return event.charCode >= 48 && event.charCode <= 57'/>
                            </td>
                            <td class="home-option nearest-option">
                                campaigns
                            </td>
                            <td class="home-option nearest-option"><input type="checkbox" id="check-show-map" checked> show map</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="col-lg-6">
                <div id="campaign-map" class="nearest-option"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}

    <div class="row" id="campaign-list">

        <div class="row" style="margin-bottom: 20px">

            <div class="col-lg-6" id="search-campaign">
                <!-- class="search" automagically makes an input a search field. -->
                <input class="search" placeholder="Search"/><span class="search-icon" style="text-align: right"><i class='fa fa-search' style="font-size: 12pt"></i></span>
                <!-- class="sort" automagically makes an element a sort buttons. The date-sort value decides what to sort by. -->
            </div>

            <div class="col-lg-6" style="text-align: right">
                <button class="sort" id="sort-campaign-by-name" data-sort="campaign-name" style="display: none">
                    Sort By Name
                </button>
                <button class="sort" id="sort-campaign-by-date" data-sort="campaign-start-date" style="display: none;">
                    Sort By Date
                </button>
                <select class="form-control" id="filter-select" style="width: 40%;float: right">
                    <option value="name">Sort By Name</option>
                    <option value="date">Sort By Date</option>
                </select>
            </div>
        </div>

        <div class="row">
        <ul class="list card-wrapper">

        </ul>
        </div>

    </div>

{% endblock %}

{% block before_base_js %}

    <style type="text/css">

        #campaign-table, #campaign-table_wrapper {
            font-size: 10pt;
        }

        #campaign-table_info {
            font-size: 9pt;
        }

        .paginate_button {
            padding: 0.3em 0.7em !important;
        }

        #campaign-table_wrapper {
            padding-bottom: 20px;
            padding-top: 10px;
        }

        #campaign-table .tag {
            font-size: 9pt;
        }

        #campaign-table_filter input[type=search] {
            border-radius: 4px;
            border: 1px solid #d1d1d1;
        }

        #campaign-table tr.odd {
            background-color: rgba(223, 234, 242, 0.30) !important;
        }


        #campaign-table tr.odd:hover, tr.even:hover {
            background-color: rgba(59, 132, 172, 0.13) !important;
        }

        .label-tag {
            font-size: 12pt;
            position: absolute;
            margin-left: 8px;
            margin-top: 12px;
        }

        .label-tag a {
            color: #bbb;
            cursor: pointer;
            opacity: 0.6;
        }

        .label-tag a:hover {
            opacity: 1.0
        }

        .label-tag .remove-tag {
            vertical-align: bottom;
            top: 0;
        }

        .label-tag a {
            margin: 0 0 0 .3em;
        }

        .label-tag a .glyphicon-white {
            color: #fff;
            margin-bottom: 2px;
        }

        #all-campaigns, #nearest-campaigns {
            display: none;
        }

    </style>

    <script type="text/javascript">

        $(function () {
            var user_location_setting = Cookies.get('user_location_setting');
            var tag = "{{ tag }}";
            if(user_location_setting === 'all' && auth.authenticated()) {
                // check current url
                var current_href = window.location.href.split('/');
                if(current_href[current_href.length-1] !== 'all' && !tag) {
                   location.href='/all';
                }
            }

            var campaignStatus = Cookies.get('campaign-status');
            if(!campaignStatus) {
                campaignStatus = 'active';
            }

            if(campaignStatus === 'active') {
                $('#display-inactive').show();
            } else if(campaignStatus === 'all') {
                $('#hide-inactive').show();
            }

        });

        var map = L.map('campaign-map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and contributors, ' +
            'under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 15
        }).addTo(map);

        $('#create-campaign').click(function () {
            if (window.isAuthenticated) {
                location.href='/create';
            } else {
                showNotifications('You need to login first.', 'danger');
            }
        });

    </script>

{% endblock %}

{% block after_base_js %}

    <script type="text/javascript">

        var table = null;
        $('.dataTables_filter').addClass('pull-left');
        var userCoordinate = '';
        var mapLayers = new L.FeatureGroup();
        var mapMarkers = new L.FeatureGroup();
        var tag = "{{ tag }}";
        var currentUrl = '';
        var currentUser = '';
        var initialLoad = true;

        map.addLayer(mapMarkers);
        map.addLayer(mapLayers);

        //---------------- EVENT ------------------//
        $('#check-show-map').click(function () {
           if( $(this).is(':checked') ){
               $('#campaign-map').show();
           } else{
               $('#campaign-map').hide();
           }
        });

        $('#filter-select').change(function () {
            var value = this.value;
            if(value == 'name') {
                $('#sort-campaign-by-name').click();
            } else if(value == 'date') {
                $('#sort-campaign-by-date').click();
            }
        });

        $('#campaigns-select').change(function () {
            var value = this.value;
            if(value == 'all') {
                Cookies.set('user_location_setting', 'all');
                location.href='/all'
            } else if(value == 'nearest') {
                Cookies.set('user_location_setting', 'nearest');
                location.href='/'
            }
        });

        $("#limit-page").on('keyup', function (e) {
            if (e.keyCode == 13) {
                updateLimitPage();
            }
        });

        $('#display-inactive').click(function () {
            Cookies.set('campaign-status', 'all');
            clearMap();
            {% if all %}
                getCampaigns(currentUrl, currentUser);
            {% else %}
                var limitPage = Cookies.get('limit_page');
                if(!limitPage) {
                    limitPage = 5;
                }
                getCampaigns(currentUrl, currentUser, limitPage);
            {% endif %}

            $('#display-inactive').hide();
            $('#hide-inactive').show();
        });

        $('#hide-inactive').click(function () {
            Cookies.set('campaign-status', 'active');
            clearMap();
            {% if all %}
                getCampaigns(currentUrl, currentUser);
            {% else %}
                var limitPage = Cookies.get('limit_page');
                if(!limitPage) {
                    limitPage = 5;
                }
                getCampaigns(currentUrl, currentUser, limitPage);
            {% endif %}

            $('#display-inactive').show();
            $('#hide-inactive').hide();
        })

        $('#limit-page').focusout(function (e) {
            updateLimitPage();
        });

        function updateLimitPage() {
            var limitPage = $("#limit-page").val();
            var oldLimitPage = Cookies.get('limit_page');
            var shouldUpdate = false;

            if(oldLimitPage) {
                if(oldLimitPage != limitPage) {
                    shouldUpdate = true;
                }
            } else {
                shouldUpdate = true;
            }

            if(shouldUpdate) {
                clearMap();
                getCampaigns(currentUrl, currentUser, limitPage);
                Cookies.set('limit_page', limitPage);
            }
        }

        function participate() {
            var participateUrl = "/participate"
            if(userCoordinate) {
                participateUrl += "?coordinate="+userCoordinate;
            }
            window.location.href = participateUrl;
        }

        function updated(user) {
            clearNotification();
            var currentUser = user.display_name;
            var url = "/campaigns";
            userCoordinate = user['lat'] + ',' + user['lon'];

            if(user['lon'] && user['lat']) {
                url = "/nearest_campaigns/" + user['lat'] + ',' + user['lon'];
            }
            clearMap();
            clearTable();
            getTotalCampaigns();
            {% if not all %}
                var limitPage = $('#limit-page').val();
                if(limitPage)
                    $('#limit-page').val(Cookies.get('limit_page'));
                $('#campaigns-select').val("nearest");
                getCampaigns(url, currentUser, limitPage);
                $('.nearest-option').show();
            {% else %}
                getCampaigns(url, currentUser);
                $('#campaigns-select').val("all");
            {% endif %}
        }

        $('.remove-tag').click(function () {
            location.href='/'
        });

        function logoutSuccess() {
            clearMap();
            clearTable();
            $('.nearest-option').hide();
            // Clear cookies
            Cookies.set('user_location_setting', '');
            {% if all %}
                location.href='/';
            {% endif %}
        }

        if(!auth.authenticated()) {
            {% if all %}
                location.href='/';
            {% endif %}
            $('#campaigns-select').val("all");
            getBrowserLocation();
            getTotalCampaigns();
        }

        function loginError() {
            getBrowserLocation();
        }

        function clearMap() {
            map.removeLayer(mapMarkers);
            map.removeLayer(mapLayers);
            mapLayers = new L.FeatureGroup();
            mapMarkers = new L.FeatureGroup();
            map.addLayer(mapMarkers);
            map.addLayer(mapLayers);
        }

        function clearTable() {
            // table.clear().draw('false');
        }

        function getBrowserLocation() {
            // Get user location
            navigator.geolocation.getCurrentPosition(successGetBrowserLocation, errorGetBrowserLocation);

            function successGetBrowserLocation(position) {
                var zoom = 10;
                var userLocation = new L.latLng(position.coords.latitude, position.coords.longitude);
                var url = "/nearest_campaigns/" + position.coords.latitude + ',' + position.coords.longitude;
                var limitPage = Cookies.get('limit_page')
                clearMap();
                if(!limitPage){
                    limitPage = $('#limit-page').val();
                }
                getCampaigns(url, null, limitPage);
                userCoordinate = position.coords.latitude + ',' + position.coords.longitude;
                map.setView(userLocation, zoom);
                $('#campaigns-select').val('nearest');
                $('.nearest-option').show();
            }

            function errorGetBrowserLocation() {
                console.log('Error get browser location');
                clearMap();
                clearTable();
                $('#campaigns-select').val('all');
                getCampaigns(null, null);
            }
        }

        function getTotalCampaigns() {
            var url = "/total_campaigns";
            $.ajax(url, {
                success: function (response) {
                    $('#active-campaign-number').html(response['campaign_total']);
                    $('#participants-number').html(response['participant_total']);
                }
            })
        }

        function getCampaigns(url, user, limit) {

            if(url) {
                currentUrl = url;
            }

            if(user) {
                currentUser = user;
            }

            $('#panel-campaign').LoadingOverlay("show", {image: "/static/resources/loading-spinner.gif"});

            if(!url) {
                url = "/campaigns";
            }
            {% if all %}
                url = "/campaigns";
            {% endif %}

            var campaign_status = Cookies.get('campaign-status');
            if(!campaign_status) {
                campaign_status = 'active';
            }

            url += '/' + campaign_status;

            if(tag) {
                url += '/'+tag;
            }

            url += '?';

            if(limit) {
                url += 'per_page='+limit+'&';
            }

            // Clear campaign list in navbar
            $('.campaign-list-navbar').html('');
            $('.card-wrapper').html('');

            var participants = [];

            $.ajax(url, {
                success: function(campaigns){
                    $.each(campaigns, function (index, campaign) {
                        var types = [];
                        var action_button = '';

                        if(campaign['types']) {
                            $.each(campaign['types'], function (index, type) {
                               types.push(type['type']);
                            });
                            types = types.join()
                        }else{
                            types = '-'
                        }

                        if($.inArray(user, campaign['campaign_managers'])>-1) {
                            action_button = '<button type="button" href="#" class="campaign-list btn"'+
                                                'onclick="location.href=\'/edit/'+campaign['uuid']+'\'">'+
                                                '<span class="pull-left">Manage</span>'+
                                             '</button>'
                        }

                        $.each(campaign['campaign_managers'], function (index, manager) {
                            if($.inArray(manager, participants)==-1) {
                                participants.push(manager);
                            }
                        });

                        // Campaign progress
                        var startDate = moment(campaign['start_date'], 'YYYY-MM-DD', true);
                        var endDate = moment(campaign['end_date'], 'YYYY-MM-DD', true);
                        var campaignRange = endDate.diff(startDate, 'days') + 1; // Include start
                        var remainingDays = endDate.diff(moment(), 'days') + 1;
                        var progress = 100 - (remainingDays / campaignRange * 100);
                        if(progress>100) {
                            progress = 100;
                        }
                        var campaignProgress = '<div class="progress" style="width:85%;float:left;">'+
                                                    '<div class="progress-bar" id="campaign-progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width:'+progress+'%">'+
                                                    '</div>'+
                                                '</div>'+ Math.round(progress) + '%';

                        var tags = '';

                        $.each(campaign['types'], function(index, type) {
                            tags += '<span class="campaign-tags">'+ type['type'] +'</span> ';
                        });

                        $('.card-wrapper').append(
                            '<li class="col-lg-6">'+
                                '<div class="campaign-card panel">'+
                                    '<div class="panel-heading">'+
                                        '<a href=/campaign/'+ campaign['uuid'] +'><div class="campaign-name">'+
                                            campaign['name'] +
                                        '</div></a>'+
                                        '<div class="row">' +
                                            '<div class="col-lg-6">'+
                                                '<div class="campaign-start-date">'+
                                                    'started '+ campaign['start_date'] +
                                                '</div>'+
                                            '</div>'+
                                            '<div class="col-lg-6">'+
                                                '<div class="campaign-progress-bar">'+
                                                    campaignProgress +
                                                '</div>'+
                                            '</div>'+
                                        '</div>' +
                                        '<div class="row">'+
                                            '<div class="col-lg-8">'+
                                                '<div>'+
                                                    tags+
                                                '</div>'+
                                                '<div class="campaign-description ellipsis multiline">'+
                                                    campaign['description']+
                                                '</div>'+
                                            '</div>'+
                                            '<div class="col-lg-4 campaign-thumbnail">'+
                                                '<img src="/thumbnail/'+campaign['thumbnail']+'">'+
                                            '</div>'+
                                        '</div>'+
                                        '<div class="row">'+
                                            '<div class="col-lg-8">'+
                                                '<div class="campaign-creator">'+
                                                        'Campaign creator <span class="campaign-creator-name">'+ campaign['campaign_creator'] + '</span>' +
                                                '</div>'+
                                            '</div>'+
                                            '<div class=col-lg-4>'+
                                                action_button+
                                            '</div>'+
                                        '</div>' +
                                    '</div>'+
                                '</div>'+
                            '</li>');

                        $(".ellipsis").ellipsis();

                        // Add to navigation bar
                        $('.campaign-list-navbar').append('<li>'+
                            '<a href="/campaign/'+campaign['uuid']+'">'+campaign['name']+'</a>'+
                        '</li>');

                        {% if not all %}
                            // Add campaign layer
                            var campaignLayer = L.geoJson(campaign['geometry'], {
                                onEachFeature: function (feature, layer) {
                                    // Check if feature is a polygon
                                    if (feature.geometry.type === 'Polygon') {
                                        // Don't stroke and do opaque fill
                                        layer.setStyle({
                                            'weight': 0.3,
                                            'fillOpacity': 0.2,
                                            'color': '#FF5722'
                                        });
                                    }
                                }
                            }).addTo(mapLayers);

                            var bounds = campaignLayer.getBounds();
                            var center = bounds.getCenter();

                            var marker = L.marker(center, {icon: orangeIcon}).addTo(mapMarkers);
                            marker.bindPopup(
                                '<div class="campaign-marker"><a href="/campaign/'+
                                    campaign['uuid'] +'"> ' +
                                    campaign['name'] +
                                '</a></div>'
                            );
                        {% endif %}
                    });

                    $('#panel-campaign').LoadingOverlay("hide");

                    {% if not all %}
                        map.invalidateSize();
                        if(mapLayers.length > 0) {
                            map.fitBounds(mapLayers.getBounds());
                        }
                    {% endif %}

                    var options = {
                        valueNames: ['campaign-name', 'campaign-start-date']
                    }
                    var campaignList = new List('campaign-list', options);

                    $('#sort-campaign-by-name').click();

                    if(initialLoad) {
                        initialLoad = false;
                    } else {
                        $('#sort-campaign-by-name').click();
                    }
                }
            });
        }

    </script>

{% endblock %}
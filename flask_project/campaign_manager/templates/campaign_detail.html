{% extends 'new_base.html' %}

{% block header_content %}

    <!-- Custom CSS -->
    <link href="/campaign_manager/static/css/campaign-detail.css" rel="stylesheet">

{% endblock %}


{% block content %}

    <div class="row">
        <div class="col-lg-7">
            <h3 class="detail-campaign-name">{{ name }}</h3>
            {% for tag in tags %}
                <label class="detail-tag"> {{ tag }} </label>
            {% endfor %}
            <p>
                {% if description %}
                    {{ description }}
                {% else %}
                    <span class="grey-italic">No description</span>
                {% endif %}
            </p>
        </div>
        <div class="col-lg-5">
             <div class="panel panel-default detail-panel-information">
                <div class="panel-body">
                    <div class="detail-campaign-status running">
                        <i class="fa fa-circle" aria-hidden="true"></i> <label>Running</label>
                    </div>
                    <div class="detail-campaign-timeline">
                        <span class="pull-left">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Started</span> : {{ start_date_date }} {{ start_date_year }}
                        </span>
                        <span class="pull-right">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Ends</span> : {{ end_date_date }} {{ end_date_year }}
                        </span>
                    </div>
                    <div class="detail-progress">
                        <div class="progress">
                          <div class="progress-bar" id="campaign-progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                          </div>
                        </div>
                    </div>
                    <div class="detail-creator-info">
                        <p>
                            <span class="grey-italic">Creator : </span>
                            {{ campaign_creator }}</p>
                        <p>
                            <span class="grey-italic">Campaign Manager : </span>
                            <span class="text-muted">
                                {% if campaign_managers %}
                                    {% for campaign_manager in campaign_managers %}
                                        <a href="https://www.openstreetmap.org/user/{{ campaign_manager }}">{{ campaign_manager }}</a>
                                        {% if campaign_manager != campaign_managers[-1] %}
                                            ,
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </p>
                        <p>
                            <span class="grey-italic">Map:</span>
                            {% if map_type != '' and map_type != 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' %}
                                <span id="map-default">
                                Default
                                </span>
                                <span id="map-custom">
                                Custom
                                <button id="choose-default" class="btn btn-info btn-manage" style="height: 20px; padding: 0; margin: 0; background-color: #77a1aa" onclick="chooseDefault()">Use Default</button>
                                </span>
                            {% else %}
                                <span id="map-default"></span>
                                Default
                            {% endif %}
                        </p>
                    </div>
                    <div class="detail-button-wrapper">
                        <button class="btn btn-info btn-manage pull-right" onclick="location.href='/campaign_manager/edit/{{ uuid }}'">Manage</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default detail-panel-information">
                <div class="panel-body">
                    <div id="campaign-map-detail"></div>

                    <div class="insight-function-panel">
                        <ul class="nav nav-tabs insight-tabs" style="display: none;">
                        </ul>
                        <div class="tab-content insight-content">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

{% endblock %}

{% block after_base_js %}

    <script src="/campaign_manager/static/libs/chartjs/Chart.bundle.min.js"></script>

    <script type="text/javascript">

        var uuid = '{{ uuid }}';
        var managers = {{ campaign_managers|safe }};
        var selected_functions = {{ selected_functions | safe }};
        var feature_collected = [];
        var feature_collected_count = 0;

        function render_selected_functions(username) {
            $('.insight-tabs').html('');
            $('.insight-content').html('');
            var index = 0;

            if(Object.keys(selected_functions).length === 0) {
                $('.insight-function-panel').html('<h4 class="grey-italic">No insight Function</h4>')
            } else {
                $('.insight-tabs').show();
            }

            $.each(selected_functions, function (key, selected_function) {
                var allow_function = true;
                if (selected_function['manager_only']) {
                    if ($.inArray(username, managers) === -1) {
                        allow_function = false;
                    }
                }
                if (allow_function) {
                    var href = "#" + key;
                    var active = '';
                    if(index===0){
                        active = 'active';
                    }
                    $('.insight-tabs').find('a[href="' + href + '"]').closest('li').remove();
                    $('.insight-tabs').append(
                        '<li class="' + active + '">' +
                        '<a href="' + href + '" data-toggle="tab" aria-expanded="true">' +
                            selected_function['name'] + '</a>' +
                        '</li>'
                    );
                    $('.insight-content').find('#' + key).remove();
                    $('.insight-content').append(
                        '<div class="tab-pane fade ' + active + ' in" id="' + key + '">' +
                            '<span class="grey-italic" style="margin-top:15px !important; position: absolute;"> Loading data .. </span>'+
                        '</div>'
                    );
                    get_function(key);
                    if (!containsObject(selected_function['feature'], feature_collected)) {
                        feature_collected.push(selected_function['feature']);
                        if (selected_function["category"] !== "coverage-function") {
                            get_metadata(key);
                        }
                    }
                    index++;
                }
            });
        }
        
        function calculateProgress() {

            var start_date = "{{ start_date }}";
            var end_date = "{{ end_date }}";

            if(start_date==='None' || end_date==='None') {
                $('.detail-campaign-status label').html('-');
                return;
            }

            start_date = moment(start_date, 'YYYY-MM-DD', true);
            end_date = moment(end_date, 'YYYY-MM-DD', true);

            var campaign_range = end_date.diff(start_date, 'days') + 1; // Include start

            if(campaign_range < 0) {
                console.log('Invalid Date');
                $('.detail-campaign-status label').html('-');
                return;
            }

            var remaining_days = end_date.diff(moment(), 'days') + 1;

            var progress = 0;

            if(remaining_days <= 0) {
                progress = 100;
                $('.detail-campaign-status').removeClass('running');
                $('.detail-campaign-status').addClass('finished');
                $('.detail-campaign-status label').html('Finished');
            } else {
                progress = remaining_days/campaign_range * 100;
            }

            $('#campaign-progress').css({
                'width': progress+'%'
            })
        }

        function findAttribution(map_url){
            var valid_map_list = ({
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'OpenStreetMap</a> and contributors, under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
                'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png' : '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png' : '&copy; Openstreetmap France | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png' : '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, '+
                'Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
                'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png' : 'Map data: &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>,'+
                ' <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
                'https://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png' : 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash;'+
                ' Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                'https://{s}.tile.openstreetmap.se/hydda/base/{z}/{x}/{y}.png' : 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}' : 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012',
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}' : 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' : 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                'https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png' : 'Wikimedia maps beta | Map data &copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
                'https://maps.wikimedia.org/osm/{z}/{x}/{y}.png' : 'Wikimedia maps beta | Map data &copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
                'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png' : '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attribution">CARTO</a>',
                });
            return valid_map_list[map_url];
        }

        //------------------ EVENT ------------------//

        function loginSuccess(user) {
        }

        function updated(user) {
            render_selected_functions(user.display_name);
            var managers = {{ campaign_managers | safe }};
            // Shows manage button if current user is one of the manager
            if($.inArray(user.display_name, managers) > -1) {
                $('.btn-manage').show();
            }
        }

        function loginError() {
            render_selected_functions('');
        }

        function logoutSuccess() {
            $('.btn-manage').hide();
            render_selected_functions('');
        }

        $(function () {
            window.isAuthenticated = auth.authenticated();
            if (!auth.authenticated()) {
                update();
            }

            calculateProgress();
        });

        document.getElementById('map-default').classList.add('hide');
        function chooseDefault() {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and contributors, ' +
            'under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 15
        }).addTo(map);
            document.getElementById('map-custom').classList.add('hide');
            document.getElementById('map-default').classList.add('show');
        }

        var drawnItems = new L.FeatureGroup();
        var map = L.map('campaign-map-detail').setView([0, 0], 1);
        var map_type = '{{ map_type }}';
        if(!map_type){
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and contributors, ' +
            'under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 15
        }).addTo(map);}
        else {
            var attribution_note = findAttribution(map_type);
            L.tileLayer(map_type, {
            attribution: attribution_note,
            maxZoom: 15
        }).addTo(map);
        }
        {% if geometry %}
            drawnItems = L.geoJSON(
                    $.parseJSON('{{ geometry|safe }}'), {
                        style: {
                            weight: 1,
                        }
                    });
            map.addLayer(drawnItems);
            map.fitBounds(drawnItems.getBounds());
        {% endif %}

        var first_function = true;
        function get_function(function_id) {
            var url = '/campaign_manager/campaign/' + uuid + '/' + function_id;
            $.ajax({
                url: url,
                success: function (data) {
                    var active = '';
                    if (first_function) {
                        active = 'active';
                        first_function = false;
                    }

                    $('#'+function_id).html(
                        data
                    );
                }
            });
        }

        function get_metadata(function_id) {
            console.log(function_id);
            var url = '/campaign_manager/campaign/' + uuid + '/' + function_id + '/metadata';
            $('#features').LoadingOverlay("show", {image: "/campaign_manager/static/resources/loading-spinner.gif"});

            $.ajax({
                url: url,
                success: function (data) {
                    var dataObj = JSON.parse(data);
                    feature_collected_count += dataObj["collected_data_count"];
                    $('#features').LoadingOverlay('hide');
                    $('#features .panel-body').html(feature_collected_count);
                }
            });
        }
        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 3,
                dashArray: '3',
                fillOpacity: 1
            });

            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            coverage_info.update(layer.feature.properties);
        }
        function resetHighlight(e) {
            coverage_layer.resetStyle(e.target);
            coverage_info.update();
        }
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

    </script>
{% endblock %}
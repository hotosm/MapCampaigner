# Common to all builds in the build matrixs
os: linux
language: python # This lets us use newer python versions from virtualenv
sudo: false
cache:
  apt: true
  pip: true
  directories:
    # commented out - we want to get fresh overpass file each time
    #- /tmp # cache any previously downloaded .osm files
  timeout: 1000
compiler: clang

python:
  - '3.6'
  - '3.5'
  - '3.4'

addons:
  postgresql: "9.6"
  apt:
    packages:
      - postgresql-9.6-postgis-2.3
      - postgis
      - osm2pgsql

env:
  global:
    - ON_TRAVIS=true
    - SECRET_KEY='tT\xd7\xb06\xf7\x9b\xff\x0fZL\xca\xca\x11\xefM\xacr\xfb\xdf\xca\x9b'
    - APP_SETTINGS=app_config.DevelopmentConfig
    - DATABASE_URL=postgresql://test_user:test_password@localhost/testing_db
    - TESTDATABASE_URL=postgresql://test_user:test_password@localhost/testing_db

matrix:
  fast_finish: true
  include:
    - python: '3.6'
      env: TRAVIS_CONFIG=PYTHON3
    - python: '3.5'
      env: TRAVIS_CONFIG=PYTHON3
    - python: '3.4'
      env: TRAVIS_CONFIG=PYTHON3

  exclude:
    - python: '3.6'
    - python: '3.5'
    - python: '3.4'

git:
  depth: 30

before_install:

install:
  - pip install coveralls
  - pip install -r deployment/docker/requirements.txt
  - pip install -r deployment/docker/requirements-dev.txt

sudo: true

before_script:
  - psql -U postgres -c "create extension postgis"
  - psql -c "CREATE DATABASE testing_db;" -U postgres
  - psql -c "CREATE USER test_user WITH PASSWORD 'test_password';" -U postgres
  - psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE testing_db to test_user;"
  - psql -U postgres -c "ALTER USER test_user CREATEDB;"
  - psql -U postgres -c "create extension postgis" -d testing_db

script:
  - cd deployment && make pep8
  - nosetests ../flask_project

after_script:
  - coveralls

email:
  - dimas@kartoza.com
  - irwan@kartoza.com
  - anita@kartoza.com
